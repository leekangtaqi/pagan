require('./commodity-ladder.html');
require('./commodity-distribution.html');

<commodity-info if="{show}">
  <div>
	<img-lazy-loader width="430" height="300" if="{!opts.commInfoAlbums.length}" class="img-responsive" holder="svg:holder.js/100px186?theme=gray&text=91pintuan.com[91拼团]"></img-lazy-loader>
	<carousel
	  height="300"
		auto="5" 
		addons="{opts.commInfoAlbums.length > 1}" 
	  item-for-loop="{opts.commInfoAlbums}" 
	  class="carousel" 
	  if="{opts.commInfoAlbums.length}" 
	  indicator-class="group-indicator"
	  index="{opts.carouselIndex}">
	</carousel>
	<div if="{opts.commInfoAlbums.length}">
	  <div if="{opts.commInfoAlbums.length <= 1}" style="height:10px"></div>
	</div>
	
	<!--不同类型拼团模板-->
	<commodity-ladder if="{opts.comm.model === 'ladder'}" commodity="{opts.comm}"></commodity-ladder>
	<commodity-distribution if="{opts.comm.model === 'distribution' || opts.comm.model === 'share'}" commodity="{opts.comm}"></commodity-distribution>
	
	<div if="{!isOffShelves()}">
	  <a href="/commodity/_{opts.comm.id}/group" class="btn-block b_middle22">开团</a>
	</div>
	<div class="selled" if="{isOffShelves()}">
	  抱歉，这个商品已经卖光了！
	</div>


	<div style="margin-top:10px;padding: 0 8px;background-color: #fff;">
	  <div class="spxq">商品详情</div>
    <!--开团分享团-->
		<img style="margin: 15px 0;max-width: 100%;" riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/ymyimg/kt-fxt.png'}" 
		if="{opts.comm.status.model === 'share'}"/>
		<!--开团佣金团-->
		<img style="margin: 15px 0;max-width: 100%;" riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/ymyimg/kt-yjt.png'}" 
		if="{opts.comm.status.model === 'distribution'}"/>
		<!--开团阶梯团-->
		<img riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/ymyimg/kt-jtt.png'}" style="margin: 15px 0;max-width: 100%;"  
		if="{opts.comm.status.model === 'ladder'}"/>
		<raw class="wc" holder="详情加载中..." content="{scrollTop?comm_detail:loading}"/>

	  <div class="m-footer1 text-center">
		商家联系方式: { opts.merchant.info.phone? opts.merchant.info.phone : opts.merchant.info.telephone }
	  </div>
	</div>
	<bottom style="background-color: #fff;"></bottom>
  </div>
  <icobar></icobar>

  <script>
	import {connect} from '../../framework/riot-redux';
	import actions from './commodity.actions';
	import docActions from '../document/document.actions';
	import Wechat from '../wechat/wechat.api';
	import moment from '../../framework/moment';
	import Cookies from '../../framework/cookie';
	
	connect(
	  state=>({
		comm: state.comm,
		merchant: state.merchant,
		commInfoAlbums: state.commInfoAlbums,
	    route: state.route
	  }),
	  dispatch=>({
		getComm: (id, done) => {dispatch(actions.getComm(id, done))},
		getCommInfoAlbums: (id, done) => {dispatch(actions.getCommInfoAlbums(id, done))},
		changeDocGroup: (action, done) => {dispatch(docActions.changeDocGroup(action, done))},
		changeCommId: (id) => {dispatch(actions.changeCommId(id))}
	  })
    )(this);
	let me = this;
	this.mixin('router');
	this.scrollTop = () => document.body.scrollTop === 0;
	this.$use(function(next, ctx){
	  context.store.dispatch({type: 'changeTitle', payload: '商品详细信息'});
	  this.loading = '<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x"></i></p>';
	  this.carouselIndex = 0;
	  this.chartData = [[[10,100],[100,10]]];
	  this.isSelling = true;
	  this.status = {
	  	open:true
	  };
	  me.opts.getComm(ctx.request.params.id, () => {
			let comm = me.opts.comm;
			let cover,img;
			if(comm.code){
				return widgets.Alert.add('warn', comm.message);
			}
			if(comm.info && comm.info.cover){
				img = 'http://img1.ifindu.cn/crop/w_120/h_120' + comm.info.cover;
				cover = 'http://img1.ifindu.cn/crop/w_540/h_360' + comm.info.cover;
			}else{
				img = 'http://static.ifindu.cn/91pintuan/images/logo.png';
				cover = null;
			}
			comm.cover = cover;
			if(comm.piece > 0 && comm.order >= comm.piece ){
				me.isSoldOut = true;
			}
			var detail = comm.info.detail;
			detail = detail.replace(/<script/g, '<p style="display:none;" ');
			detail = detail.replace(/script>/g, 'p>');
			var txtDetail = htmlToPlaintext(detail);
			var groupNumStr = comm.partakers + "人成团";
			var title = comm.info.name;
			context.store.dispatch({type: 'changeTitle', payload: title});
			var price = "原　价: " + comm.price + "元";
			var discount = "拼团价: " + comm.discount + "元";
			var desc = price + '\n' + discount + '\n' + groupNumStr;
			var timeline = title.substr(0,16) + '~' + price + ';' + discount + ';' + groupNumStr;
			this.comm_detail = detail;
			me.isSelling =  moment().isBefore(comm.time_end) && comm.stat===1;
			me.isOffShelves = () => (!me.isSelling || me.isSoldOut);
			comm.model === 'share' && me.opts.changeDocGroup({type: 'url', meta: 'model4rewardRules'});
			comm.model === 'distribution' && me.opts.changeDocGroup({type: 'url', meta: 'rewardRules'});
			if(comm.model === 'ladder'){
				me.opts.changeDocGroup({type: 'text', meta: '开团当团长，率领众好友享受优惠！'});
				me.money={
					price:comm.price,
					ladder:0,
					cheaper:0
				};
				title = '人多力量大！' + title;
				desc = '', timeline = title.substr(0,16);
				if(comm.ladder.prices && comm.ladder.prices.length){
					comm.ladder.prices.forEach((val, key)=>{
						let money = me.money;
						if(val.price < money.ladder){
							money.cheaper = money.price - val.price;
						}
						if(key<3){
							desc += val.people+"人价:" + val.price + "元\n ";
							timeline += ' ' + val.people + "人价:" + val.price + "元";
						}
						money.ladder = val.price;
					})
				}
			}
			me.opts.changeCommId(comm.id);
			Cookies.set('commId',comm.id);
			setTimeout(()=>{
				Wechat.ready({url: window.location.href, title: title, desc: desc, timeline: timeline, img: img});
			}, 50)
			this.opts.getCommInfoAlbums(comm.id);
			next();
	  });
	})
	
	/**
	 * helpers
	 */
	function htmlToPlaintext(text) {
	  return String(text).replace(/<[^>]+>/gm, '');
	}
	
  </script>
</commodity-info>