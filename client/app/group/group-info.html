require('./group-distribution.html');
require('./group-ladder.html');

<group-info show="{show}">
  <div>
    <img-lazy-loader width="430" height="300" 
			if="{!opts.commInfoAlbums.length}" class="img-responsive" 
			holder="svg:holder.js/100px186?theme=gray&text=91pintuan.com[91拼团]"
		></img-lazy-loader>
		<carousel
			height="300"
			auto="5" 
			addons="{opts.commInfoAlbums.length > 1}" 
			item-for-loop="{opts.commInfoAlbums}" 
			class="carousel" 
			if="{opts.commInfoAlbums.length}" 
			indicator-class="group-indicator"
			index="{opts.carouselIndex}">
		</carousel>

		<div if="{opts.commInfoAlbums.length}">
			<div if="{opts.commInfoAlbums.length <= 1}" style="height:15px"></div>
		</div>
		
		<group-distribution if="{opts.group.commodity.model === 'distribution' || opts.group.commodity.model === 'share'}" group="{opts.group}" isbefore="{isBefore}"></group-distribution>
		<group-ladder if="{opts.group.commodity.model === 'ladder'}" group="{opts.group}" isbefore="{isBefore}"></group-ladder>

		<div if="{!isOffShelves}">
			<div class="box_pic">
				<button class="btn btn-block b_middlemy" class="{ijoin1: isBefore, btn_no: !isBefore}" onclick="{joinModal}">参团</button>
			</div>
		</div>

		<div if="{1 == opts.group.commodity.group}">
			<a href="/commodity/_{opts.group.commodity.id}/group" class="btn btn-block b_middle3"></a>
			<div class="cont_text3 fontsize1" style="margin-top:10px; margin-bottom:0px">
			<div class="row">
				<div class="col-xs-1">
					<div class="illlogo" style="margin:7px 4px 8px 5px"></div>
				</div>
				<div class="col-xs-11">
					<div style="margin:5px 5px 8px 10px;">
					<div style="text-align:justify; text-justify:inter-ideograph">
						<span compile="docGroup"></span>
					</div>
					</div>
				</div>
			</div>
			</div>
		</div>

		<div class="selled" if="{isOffShelves}">
			抱歉，这个商品已经卖光了！
		</div>

		<div style="margin-top:10px;padding: 0 8px;background-color: #fff;">
			<div class="spxq">商品详情</div>

			<!--参团分享团-->
			<img style="margin: 15px 0;max-width: 100%;" riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/ymyimg/ct-fxt.png'}" if="{opts.group.commodity.status.model === 'share'}" />
			<!--参团佣金团-->
			<img style="margin: 15px 0;max-width: 100%;" riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/ymyimg/ct-fxt.png'}" if="{opts.group.commodity.status.model === 'distribution'}" />
			<!--参团阶梯团-->
			<img style="margin: 15px 0;max-width: 100%;" riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/ymyimg/ct-jtt.png'}" if="{opts.group.commodity.status.model === 'ladder'}" />
			<raw class="wc" holder="详情加载中..." content="{scrollTop?comm_detail:loading}"/>
		</div>
		<div class="m-footer1 text-center">
			商家联系方式: { opts.merchant.info.phone? opts.merchant.info.phone : opts.merchant.info.telephone }
		</div>
		<bottom></bottom>
  </div>
  <icobar></icobar>

  <script>
	import {connect} from '../../framework/riot-redux';
	import commActions from '../commodity/commodity.actions';
	import moment from '../../framework/moment';
	import Cookies from '../../framework/cookie';
	import Wechat from '../wechat/wechat.api';
	connect(
	  state => ({
		  merchant: state.merchant,
			group: state.group,
			route: state.route,
			commInfoAlbums: state.commInfoAlbums
	  }),
	  dispatch => ({
		  changeTitle: title => dispatch({type: 'changeTitle', payload: title}),
		  changeCommId: commId => dispatch({type: 'changeCommId', payload: commId}),
			getCommInfoAlbums: (id, done) => {dispatch(commActions.getCommInfoAlbums(id, done))}
	  })
	)(this)
	var me = this;
	this.mixin('router');
	this.isBefore = true;
	this.isSelling = true;
	this.isSoldOut = false;
	this.statusopen = true;
	this.docGroup = '开团当团长，分享给好友们，成团后享受优惠！';
	this.on('update', ()=>{
		if(!this.opts.group || !Object.keys(this.opts.group).length){
			return;
		}
		this.isBefore =  moment().isBefore(this.opts.group.time_end);
		this.isSelling =  moment().isBefore(this.opts.group.commodity.time_end) && this.opts.group.commodity.stat===1;
		this.isContinue = this.opts.group.commodity.continue;
		this.isOffShelves = !this.isSelling || this.isSoldOut;
		if(this.opts.group.commodity.piece>0 && this.opts.group.commodity.order>=this.opts.group.commodity.piece ){
			this.isSoldOut = true;
	  }
		this.numJoin = this.opts.group.num_order;
	  this.numNeed = this.opts.group.commodity.partakers;
		this.isJoin = this.isBefore && (this.numJoin < this.numNeed || (this.numJoin >= this.numNeed && this.isContinue));
	});
	this.$use(function(next, ctx){
	  let group = me.opts.group;
	  let comm = group.commodity;
	  let txtDetail = htmlToPlaintext(comm.info.name);
	  let diff = group.commodity.partakers - group.num_order;
	  let end_time_str = "已结束";
	  let diffStr = null;
	  let img = null;
	  let title = comm.info.name;
	  let colonel = group.address.name;
	  let group_name = colonel.substr(0,4) + '的团';
	  let price = "原　价: " + comm.price + "元";
	  let discount = "拼团价: " + comm.discount + "元";
	  let desc = '';
	  let timeline = title.substr(0,16) + '~' + group_name + ',' + diffStr;
	  let detail = comm.info.detail;
	  detail = detail.replace(/<script/g, '<p style="display:none;" ');
	  detail = detail.replace(/script>/g, 'p>');
	  if(diff>0){
			diffStr = "还差" + diff + "人成团";
	  }else{
			diffStr = "已有" + group.num_order + "人参团";
	  }
	  if (group.isBefore) {
			end_time_str = "剩余时间: " + (Math.ceil(parseInt(moment(group.time_end).fromNow())/(3600*24*1000)) + '天内');
	  }
	  if(comm.info.cover){
			img = 'http://img1.ifindu.cn/crop/w_120/h_120'+comm.info.cover;
	  }else{
			img = undefined;
	  }
	  me.comm_detail = detail;
	  me.scrollTop = () => document.body.scrollTop === 0;
	  me.opts.changeTitle(group.address.name + '的团');
	  me.loading = '<p class="text-center"><i class="fa fa-spinner fa-pulse fa-2x"></i></p>';
	  me.opts.changeCommId(comm.id);
	  Cookies.set('commId',comm.id);
		me.opts.getCommInfoAlbums(comm.id);
	  if(comm.model === 'ladder'){
	    me.money = {
				key:0,
				price:0,
				people:0,
				order:0
	    };
	    title = '人多力量大！'+title;
	    desc = '',timeline=title.substr(0,16);
	    comm.ladder.prices.forEach((price,key) => {
		  if(group.num_order >= price.people){
				me.money.key = key;
		    me.money.price = price.price;
		    me.money.people = price.people;
		    me.money.order = group.num_order;
	 	  }
	      me.money.max = price.people;
		  if(key<3){
		    desc += price.people+"人价:"+price.price+"元\n ";
		    timeline += ' '+price.people+"人价:"+price.price+"元";
		  }
	    });
	  }	
		desc = group_name + '\n' + diffStr + '\n' + end_time_str;
		setTimeout(() => {
			Wechat.ready({url: window.location.href, title: title,desc: desc, timeline: timeline, img:img});
		}, 50)
	  next();
	})

	this.joinModal = () => {
		if(this.isJoin){
			if(this.opts.group.commodity.sku && this.opts.group.commodity.sku.length){
				widgets.Modal.open({
					tag: 'group-sku-modal',
					size: 'lg',
					props: {
						group: this.opts.group
					}
				})
				return;
			}
			let query = {id: this.opts.group.id, showwxpaytitle: 1, tag: 'group-info-join'};
			let querystring = $.util.querystring.stringify(query);
			riot.route('/wepay?' + querystring);
			return;
		}
		
		widgets.Modal.open({
			tag: 'group-modal-post',
			size: 'lg',
			props: {
				commId: this.opts.group.commodity.id,
				grpId: this.opts.group.id,
				isMore: this.numJoin >= this.numNeed ? true : false,
				isBefore: this.isBefore,
				isSelling: this.isSelling,
				isContinue: this.isContinue,
				isSoldOut: this.isSoldOut,
				model: this.opts.group.commodity.model
			}
		})

		return false;
	}

	this.share = () => {
		widgets.Modal.open({
			tag: 'group-share'
		});
	};

	/**
	 * helpers
	 */
	function htmlToPlaintext(text) {
	  return String(text).replace(/<[^>]+>/gm, '');
	}
  </script>
</group-info>

