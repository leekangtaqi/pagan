<order-detail show="{show}">
	<div>
		<div>
			<p class="cjsj">创建时间:{$.util.filter.date(new Date(opts.partaker.time_join), 'yyyy-MM-dd hh:mm')}</p>
				<div class="zhuangtai">
					<span>{opts.partaker.group.isBefore?'拼团中':'截团'}</span>
					<span if="{opts.partaker.commodity.model !== 'ladder'}">
						{opts.partaker.status.success ? '成团' : '未成团'}
					</span>
				</div>
				<p class="bigmoney" if="{opts.partaker.commodity.model !== 'ladder'}">{$.util.filter.currency(opts.partaker.commodity.discount)}</p>
		</div>
		<div class="tc"></div>
		<table class="tabl">
			<tr>
				<td style="border-top: none;" colspan=2>
					<div class="media">
						<div class="media-left">
							<a href="/group/_{opts.partaker.group.id}">
								<img class="media-object" style="height:55px;" riot-src="{'http://img1.ifindu.cn/crop/w_430/h_310'+ opts.partaker.commodity.cover}" alt="{opts.partaker.commodity.name}" if="{opts.partaker.commodity.cover}">
								<img class="media-object" holder="holder.js/120x85?theme=gray&text=91拼团" alt="{opts.partaker.commodity.name}" class="img-responsive" if="{!opts.partaker.commodity.cover}">
							</a>
						</div>
						<div class="media-body">
							<a href="/group/_{opts.partaker.group.id}">
								<h4 class="media-heading1 myw">{opts.partaker.commodity.name}</h4>
								<img riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/ymyimg/jtright.png'}" style="height: 20px;margin-top: 14px;"/>
								<div style="float: left;color: #898989;" if="{opts.partaker.commodity.model !== 'ladder'}">拼团价:{$.util.filter.currency(opts.partaker.commodity.discount)}</div>
								<div style="color: #898989;" if="{opts.partaker.commodity.model==='ladder'}">
									拼团价:<span each="{ldprc in opts.partaker.commodity.ladder.prices}">{ldprc.price}<i if="{idx != opts.partaker.commodity.ladder.prices.length-1}">/</i></span>元
								</div>
								<div if="{can_balance}">
									<a href="/wepay?tag=group-info-replenishment&id={opts.partaker.group.id}&showwxpaytitle=1"
										class="btn btn-danger btn-xs bkaa"
										target="_blank"
										class="{ysxaa : !ifBalance}"
									>
										{ifBalance ? '补款' : '已过期'}
									</a>
								</div>
							</a>
						</div>
					</div>
				</td>
			</tr>
			<tr>
				<td class="colo1">订单号:</td>
				<td class="colo2">{opts.partaker.id}</td>
			</tr>
			<tr>
				<td class="colo1">创建时间:</td>
				<td class="colo2">{$.util.filter.date(new Date(opts.partaker.time_join), 'yyyy-MM-dd hh:mm')}</td>
			</tr>
			<tr>
				<td class="colo1">买家信息:</td>
				<td class="colo2">{opts.partaker.address.name+ '　' + opts.partaker.address.telephone}</td>
			</tr>
			<tr if="{opts.partaker.poi}">
				<td class="colo1">自提门店:</td>
				<td class="colo2">{opts.partaker.poi.base_info.business_name+(opts.partaker.poi.base_info.branch_name?'('+opts.partaker.poi.base_info.branch_name+')':'')}
					<span class="pull-right" onclick="{openLocation}" style="margin-right:20px;">
						<img style="width: 16px;height: 20px;" riot-src="{'http://91pt.oss-cn-beijing.aliyuncs.com/home/sjdicon/sjddizhidaohang.png'}" alt="" />
					</span>
				</td>
			</tr>
			<tr>
				<td class="colo1">{status.qrcode?'消费信息:':'物流信息:'}</td>
				<td class="colo2" if="{opts.partaker.status.trade===1}">{status.qrcode?'已消费':'已发货'}</td>
				<td class="colo2" if="{opts.partaker.status.trade!==1}">{status.qrcode?'未消费':'未发货'}</td>
			</tr>
			<tr if="{!status.qrcode}">
				<td class="colo1">收货地址:</td>
				<td class="colo2">{opts.partaker.address.addr}</td>
			</tr>
			<tr if="{!status.qrcode}">
				<td class="colo1" style="border-bottom: 1px solid #dadadb;">快递单号:</td>
				<td style="border-bottom: 1px solid #dadadb;" class="colo2">
					<a href="http://m.kuaidi100.com/index_all.html?type={opts.partaker.express.company.id}&postid={opts.partaker.express.no}&callbackurl=http://{merchant.pubno.appid}.wx.91pintuan.com/order/{opts.partaker.id}">
						{opts.partaker.express.company.name} {opts.partaker.express.no}
					</a>
				</td>
			</tr>
			<tr if="{status.qrcode}">
				<td class="colo1">消费码：</td>
				<td class="colo2">到店消费时，请向商家出示此二维码</td>
			</tr>
			<tr if="{status.qrcode}">
				<td style="border-top: none;" colspan="2">
					<img riot-src="{qrcode}" style="width:100%">
				</td>
			</tr>
		</table>
		<rlink class="ywtk" to="/order/_{opts.partaker.id}/refund">对订单有疑问？</rlink>
	</div>

	<script>
		import {connect} from 'riot-redux'
		import moment from '../../framework/moment'
		connect(
			state => ({
				partaker: state.partaker,
				qrcode: state.qrcode
			})
		)(this);
		this.mixin('router');
		this.status = {qrcode:false};
		this.can_balance = false;
		this.$use(function(next){
			this.title = '订单详情';
			this.can_balance = false;
			this.status = {qrcode:false};
			next();
		});
		this.on('update', ()=>{
			if(!this.opts.partaker.group){
				return;
			}
			var partaker  = this.opts.partaker;
			var group     = partaker.group;
      var commodity = partaker.commodity;
			this.ifBalance =  moment().isBefore(commodity.time.end);
			if(partaker.commodity.model==='ladder' && partaker.status.balance!==1){
        var people    = commodity.ladder_people;
        var balance   = group.num.balance;
        var order     = group.num.partakers.order;
        if(order >= people) this.can_balance = true;
        if(!partaker.group.isBefore) this.can_balance = true;
      }
      if(commodity.status.qrcode){
        if(this.opts.qrcode){
          this.qrcode = `https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=${this.opts.qrcode}`;
        } else {
					fetch('/qrcode?id=' + partaker.id, {method: 'get'}).then(data => {
						this.update({qrcode: data});
          });
        }
        this.status.qrcode = true;
      }
      if(commodity.status.qrgun){
        this.status.qrcode = true;
				fetch('/qrcode?id=' + '91PINTUAN:' + partaker.qrgun, {method: 'get'}).then(data => {
					this.update({qrcode: data});
				});
      }
      //未成团不显示二维码
      if(!partaker.status.success){
        this.status.qrcode = false;
      }
		})

    this.openLocation = function () {
      var poi = this.opts.partaker.poi.base_info;
      wx.ready(function(){
        wx.openLocation({
          latitude: poi.latitude,
          longitude: poi.longitude,
          name: poi.business_name + '' + poi.branch_name,
          address: poi.province+poi.city+poi.district + poi.address,
          scale: 17,
          infoUrl: window.location.href,
          fail: function(res){location.reload();}
        });
      });
    }
	</script>
</order-detail>